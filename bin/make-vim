#!/usr/bin/env bash

# Determine current vim version
v=$(vim --version | head -1 | cut -d ' ' -f 5)
p=$(vim --version | grep 'Included patches:' | cut -d '-' -f 2)
p=$(printf '%04d' $p)

echo "Current installed vim version:" $v.$p

# Determine latest patch version
version="$(git ls-remote --tags https://github.com/vim/vim.git | grep 'v8.2.' | sed -nE 's#.*refs/tags/v?([0-9]+(\.[0-9]+)*)$#\1#p' | sort -Vr | head -n 1)"

echo "Latest vim version on github: " $version
major=$(echo $version | cut -d. -f1)
minor=$(echo $version | cut -d. -f2)
patch=$(echo $version | cut -d. -f3)


if [[ $v.$p == $version ]]; then
  echo "Latest version of vim already installed."
  exit 0
fi

read -p "Continue and build latest vim? (y/n) " cont
if [[ $cont != 'y' ]]; then
  exit 0
fi

url="https://github.com/vim/vim/archive/v$version".tar.gz

work_dir=$(mktemp -d /tmp/vim.XXXXXX)
cd $work_dir

echo "Retrieving $url..."
if ! curl -L --silent $url --output v"$version".tar.gz; then
  echo "Does not exist: $url"
  exit 1
fi
tar -xf v"$version".tar.gz
cd vim-"$version"

echo "Configuring..."
./configure \
    --silent \
    --with-features=huge \
    --enable-rubyinterp=no \
    --enable-pythoninterp=no \
    --enable-python3interp=no \
    --enable-perlinterp=no \
    --enable-luainterp=no \
    --enable-tclinterp=no \
    --enable-mzschemeinterp=no \
    --disable-arabic \
    --enable-cscope \
    --disable-netbeans \
    --disable-rightleft \
    --prefix=/usr/local

echo "Building..."
make --silent VIMRUNTIMEDIR=/usr/local/share/vim/vim"$major$minor" &>/dev/null

echo "Installing..."
make --silent install &>/dev/null

echo "Cleaning up..."
rm -rf $work_dir
echo "Done"
